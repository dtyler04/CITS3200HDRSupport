{% extends "base.html" %}
{% block title %}Student Dashboard{% endblock %}
{% block content %}
<div class="row">
    <div class="col">
        <h1 class="mb-2">Welcome back, {{ first_name }}!</h1>
        <p class="text-muted">Here is a quick overview of your reminders, messages and wellbeing support.</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-8">
        <div class="card p-3 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="m-0">Reminders & Messages</h3>
                <div>
                    <div class="btn-group btn-group-sm" role="group" aria-label="type">
                        <button id="showReminders" class="btn btn-outline-primary">Reminders</button>
                        <button id="showMessages" class="btn btn-outline-primary">Messages</button>
                        <button id="showAll" class="btn btn-outline-primary active">All</button>
                    </div>
                    <div class="btn-group btn-group-sm ms-2" role="group" aria-label="view">
                        <button id="viewList" class="btn btn-outline-secondary active">List</button>
                        <button id="viewCalendar" class="btn btn-outline-secondary">Calendar</button>
                    </div>
                </div>
            </div>

            <!-- Calendar Date Selector (only shown in calendar view) -->
            <div id="calendar-selector" style="display:none;" class="mb-3">
                <label for="date-picker" class="form-label">Select Date:</label>
                <input type="date" id="date-picker" class="form-control" style="max-width: 200px;">
            </div>

            <!-- List Views -->
            <div id="reminders-list" style="display:none;">
                <ul class="list-group" style="max-height: 400px; overflow-y: auto;">
                    {% for r in reminders %}
                    <li class="list-group-item">
                        <strong>{{ r.title }}</strong>
                        <div class="small text-muted">{{ r.scheduled_at.strftime('%Y-%m-%d %H:%M') if r.scheduled_at else 'No date' }}</div>
                        <div>{{ r.content }}</div>
                    </li>
                    {% else %}
                    <li class="list-group-item text-muted">No reminders.</li>
                    {% endfor %}
                </ul>
            </div>

            <div id="messages-list" style="display:none;">
                <ul class="list-group" style="max-height: 400px; overflow-y: auto;">
                    {% for m in messages %}
                    <li class="list-group-item">
                        <strong>{{ m.title }}</strong>
                        <div class="small text-muted">{{ m.scheduled_at.strftime('%Y-%m-%d %H:%M') if m.scheduled_at else 'Now' }}</div>
                        <div>{{ m.message_content }}</div>
                    </li>
                    {% else %}
                    <li class="list-group-item text-muted">No messages.</li>
                    {% endfor %}
                </ul>
            </div>

            <div id="all-list">
                <ul class="list-group" style="max-height: 400px; overflow-y: auto;">
                    {% set combined_items = [] %}
                    {% for r in reminders %}
                        {% set _ = combined_items.append(('reminder', r)) %}
                    {% endfor %}
                    {% for m in messages %}
                        {% set _ = combined_items.append(('message', m)) %}
                    {% endfor %}
                    {% if combined_items %}
                        {% for item_type, item in combined_items|sort(attribute='1.scheduled_at')|reverse %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <strong>{{ item.title }}</strong>
                                    <div class="small text-muted">
                                        {{ item.scheduled_at.strftime('%Y-%m-%d %H:%M') if item.scheduled_at else 'Now' }}
                                    </div>
                                    <div>{{ item.content if item_type == 'reminder' else item.message_content }}</div>
                                </div>
                                <span class="badge bg-{{ 'primary' if item_type == 'reminder' else 'info' }} ms-2">
                                    {{ 'Reminder' if item_type == 'reminder' else 'Message' }}
                                </span>
                            </div>
                        </li>
                        {% endfor %}
                    {% else %}
                    <li class="list-group-item text-muted">No reminders or messages.</li>
                    {% endif %}
                </ul>
            </div>

            <!-- Calendar Views -->
            <div id="reminders-calendar" style="display:none;">
                <div id="reminders-calendar-content">
                    <p class="small text-muted">Select a date above to view reminders for that day.</p>
                </div>
            </div>

            <div id="messages-calendar" style="display:none;">
                <div id="messages-calendar-content">
                    <p class="small text-muted">Select a date above to view messages for that day.</p>
                </div>
            </div>

            <div id="all-calendar" style="display:none;">
                <div id="all-calendar-content">
                    <p class="small text-muted">Select a date above to view all items for that day.</p>
                </div>
            </div>
        </div>

        <div class="card p-3 mb-4">
            <h4 class="mb-3">Student Wellbeing Support</h4>
            {% for post in wellbeing_posts %}
            <div class="mb-3">
                <h5 class="mb-1">{{ post.title }}</h5>
                <div class="small text-muted">{{ post.created_at }}</div>
                <p class="mb-1">{{ post.content }}</p>
                {% if post.image_filename %}
                  <img src="{{ url_for('uploaded_file', filename=post.image_filename) }}" class="img-fluid mt-2" style="max-height:220px;">
                {% endif %}
            </div>
            <hr>
            {% else %}
            <p class="text-muted">No wellbeing posts yet.</p>
            {% endfor %}

            <h5 class="mt-3">Contact & Support</h5>
            <ul class="list-unstyled">
                {% for c in contacts %}
                <li class="mb-2">
                    <strong>{{ c.service_type }}:</strong> {{ c.name }} â€" <span class="text-muted">{{ c.info }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card p-3 mb-4">
            <h5>Your quick stats</h5>
            <ul class="list-unstyled small">
                <li>Unread messages: <strong>{{ messages|length }}</strong></li>
                <li>Upcoming reminders: <strong>{{ reminders|length }}</strong></li>
            </ul>
        </div>

        <!-- My Profile Section -->
            <div class="col-md-14">
                <div class="card">
                    <div class="card-body">
                        <h3>My Profile</h3>
                        <p><strong>First Name:</strong> {{ user.first_name }}</p>
                        <p><strong>Last Name:</strong> {{ user.last_name }}</p>
                        <p><strong>Student ID:</strong> {{ user.user_id }}</p>
                        <p><strong>Email:</strong> {{ user.email }}</p>
                        <p><strong>Location:</strong> {{ enrollment_update.location | capitalize }}</p>
                        <p><strong>Degree Type:</strong> {{ degree_type | capitalize }}</p>
                        <p><strong>Study Mode:</strong> {{ enrollment_update.study_mode.replace('-', ' ') | title }}</p>
                        <p><strong>Degree Code:</strong> {{ enrollment_update.degreeCode }}</p>
                        <h5>Candidature Progress</h5>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: {{ progress_percentage }}%;" aria-valuenow="{{ progress_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                {{ progress_percentage }}%
                            </div>
                        </div>
                        <p><small>Started: {{ start_date.strftime('%Y-%m-%d') if start_date else 'Unknown' }}</small></p>
                    </div>
                </div>
            </div>
    </div>
    <div class="container mt-5 pb-5"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const btnRem = document.getElementById('showReminders');
    const btnMsg = document.getElementById('showMessages');
    const btnAll = document.getElementById('showAll');
    const btnList = document.getElementById('viewList');
    const btnCal = document.getElementById('viewCalendar');
    const datePicker = document.getElementById('date-picker');
    const calendarSelector = document.getElementById('calendar-selector');

    let currentType = 'all';
    let currentView = 'list';

    function hideAllSections() {
        document.getElementById('reminders-list').style.display = 'none';
        document.getElementById('messages-list').style.display = 'none';
        document.getElementById('all-list').style.display = 'none';
        document.getElementById('reminders-calendar').style.display = 'none';
        document.getElementById('messages-calendar').style.display = 'none';
        document.getElementById('all-calendar').style.display = 'none';
    }

    function showSection(type, view) {
        hideAllSections();
        
        // Show/hide calendar selector
        if (view === 'calendar') {
            calendarSelector.style.display = 'block';
        } else {
            calendarSelector.style.display = 'none';
        }

        const sectionId = type + '-' + view;
        const section = document.getElementById(sectionId);
        if (section) {
            section.style.display = 'block';
        }
    }

    function updateActiveButtons() {
        // Update type buttons
        [btnRem, btnMsg, btnAll].forEach(btn => btn.classList.remove('active'));
        if (currentType === 'reminders') btnRem.classList.add('active');
        else if (currentType === 'messages') btnMsg.classList.add('active');
        else if (currentType === 'all') btnAll.classList.add('active');

        // Update view buttons
        [btnList, btnCal].forEach(btn => btn.classList.remove('active'));
        if (currentView === 'list') btnList.classList.add('active');
        else if (currentView === 'calendar') btnCal.classList.add('active');
    }

    function loadCalendarData(selectedDate) {
        if (!selectedDate) return;

        // Make AJAX request to get events for the selected date
        fetch(`/get_events?date=${selectedDate}`)
            .then(response => response.json())
            .then(events => {
                updateCalendarContent(events, selectedDate);
            })
            .catch(error => {
                console.error('Error fetching events:', error);
                updateCalendarContent([], selectedDate);
            });
    }

    function updateCalendarContent(events, selectedDate) {
        const remindersContent = document.getElementById('reminders-calendar-content');
        const messagesContent = document.getElementById('messages-calendar-content');
        const allContent = document.getElementById('all-calendar-content');

        const reminders = events.filter(e => e.content !== undefined);
        const messages = events.filter(e => e.message_content !== undefined);

        // Update reminders calendar content
        if (reminders.length === 0) {
            remindersContent.innerHTML = `<p class="text-muted">No reminders for ${selectedDate}.</p>`;
        } else {
            remindersContent.innerHTML = '<ul class="list-group">' +
                reminders.map(r => `
                    <li class="list-group-item">
                        <strong>${r.title}</strong>
                        <div class="small text-muted">${r.scheduled_at}</div>
                        <div>${r.content}</div>
                    </li>
                `).join('') + '</ul>';
        }

        // Update messages calendar content
        if (messages.length === 0) {
            messagesContent.innerHTML = `<p class="text-muted">No messages for ${selectedDate}.</p>`;
        } else {
            messagesContent.innerHTML = '<ul class="list-group">' +
                messages.map(m => `
                    <li class="list-group-item">
                        <strong>${m.title}</strong>
                        <div class="small text-muted">${m.scheduled_at}</div>
                        <div>${m.message_content}</div>
                    </li>
                `).join('') + '</ul>';
        }

        // Update all calendar content
        if (events.length === 0) {
            allContent.innerHTML = `<p class="text-muted">No items for ${selectedDate}.</p>`;
        } else {
            allContent.innerHTML = '<ul class="list-group">' +
                events.map(item => `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <strong>${item.title}</strong>
                                <div class="small text-muted">${item.scheduled_at}</div>
                                <div>${item.content || item.message_content}</div>
                            </div>
                            <span class="badge bg-${item.content !== undefined ? 'primary' : 'info'} ms-2">
                                ${item.content !== undefined ? 'Reminder' : 'Message'}
                            </span>
                        </div>
                    </li>
                `).join('') + '</ul>';
        }
    }

    // Event listeners for type buttons
    btnRem.addEventListener('click', function() {
        currentType = 'reminders';
        updateActiveButtons();
        showSection(currentType, currentView);
        if (currentView === 'calendar' && datePicker.value) {
            loadCalendarData(datePicker.value);
        }
    });

    btnMsg.addEventListener('click', function() {
        currentType = 'messages';
        updateActiveButtons();
        showSection(currentType, currentView);
        if (currentView === 'calendar' && datePicker.value) {
            loadCalendarData(datePicker.value);
        }
    });

    btnAll.addEventListener('click', function() {
        currentType = 'all';
        updateActiveButtons();
        showSection(currentType, currentView);
        if (currentView === 'calendar' && datePicker.value) {
            loadCalendarData(datePicker.value);
        }
    });

    // Event listeners for view buttons
    btnList.addEventListener('click', function() {
        currentView = 'list';
        updateActiveButtons();
        showSection(currentType, currentView);
    });

    btnCal.addEventListener('click', function() {
        currentView = 'calendar';
        updateActiveButtons();
        showSection(currentType, currentView);
        if (datePicker.value) {
            loadCalendarData(datePicker.value);
        }
    });

    // Date picker event listener
    datePicker.addEventListener('change', function() {
        if (currentView === 'calendar') {
            loadCalendarData(this.value);
        }
    });

    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    datePicker.value = today;

    // Initialize the view
    updateActiveButtons();
    showSection(currentType, currentView);
});
</script>
{% endblock %}